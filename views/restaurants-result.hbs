<h2>Where you want to go?</h2>

<div id="map"></div>
<!--<button type="submit" onclick="showMarkers({{markers}})">Show Markers</button>-->
<!--<button type="submit" onclick="calcRoute()">Route</button>-->
<div>
  <form id="routeSearchForm" action="#" method="GET">
    <label for="start">
      <input type="text" id="start" name="route-search-start" placeholder="starting point">
    </label>
    <label for="end">
      <input type="text" id="end" name="route-search-end" placeholder="destination">
    </label>
    <button type="submit" onclick="calcRoute()">Add route</button>
    <button type="submit" id="clear-route" onclick="clearRoute()">Clear route</button>
    <button type="submit" id="clear-markers" onclick="clearMarkers()">Clear markers</button>
  </form>
</div>
<button type="submit" onclick="getCurrentLocation()">Get current location</button>
<div>
  <form action="#" id="placesForm" method="GET">

    <input type="checkbox" id="restaurants" name="restaurants">
    <label for="restaurants">Restaurants</label>
    <input type="checkbox" id="bars" name="bars">
    <label for="bars">Bars</label>
    <input type="checkbox" id="bakeries" name="bakeries">
    <label for="bakeries">Bakeries</label>

    <button type="submit">Search Places</button>
  </form>
</div>
<script>
  let markers = [];
  let routeDestinationCoordinates;
  let directionsService;
  let directionsRenderer;

  /*

  const zomatoAPI = axios.create({
    baseURL: 'https://developers.zomato.com/api/v2.1/',
    headers: { 'user-key': "83cd93e9820f4153649a4d837be70144" }
  });

  function parseQuery(string) {
    string.replace(" ", "%")
  }

  function getFirst(restaurant) {
    zomatoAPI.get("/search", {
      params: {
        q: parseQuery(restaurant.name),
        sort: "real_distance",
        order: "desc",
        lat: restaurant.geometry.location.lat(),
        lon: restaurant.geometry.location.lng()
      }
    }).then((response) => {
      console.log(restaurant.name)
      console.log(response)
    })
  }

  let firstRestaurant;


  function deleteMarkers() {
    clearMarkers();
    customMarker = [];
  }
  */

  function searchPlaces(event) {

    let restaurant = event.path[0][0];
    let bar = event.path[0][1];
    let bakeries = event.path[0][2];

    let checkedTypes = [];
    if (restaurant.checked) {
      checkedTypes.push('restaurant')
    } else if (bar.checked) {
      checkedTypes.push('bar')
    } else if (bakeries.checked) {
      checkedTypes.push('bakery')
    } else {
      clearMarkers();
    }

    if (!checkedTypes.length) {
      alert('Please select one option')
    } else {
      let request = {
        location: routeDestinationCoordinates,
        radius: "100",
        type: checkedTypes
      };
      let service = new google.maps.places.PlacesService(map)

      service.nearbySearch(request, (results, status) => {

        if (status === google.maps.places.PlacesServiceStatus.OK) {
          for (let i = 0; i < results.length; i++) {
            let name = results[i].name
            let lat = results[i].geometry.location.lat();
            let lng = results[i].geometry.location.lng();
            setMarker({ lat, lng }, name)
            map.setCenter(routeDestinationCoordinates);
            map.setZoom(18);
          };
        };
      });

    }
  };


  function calcRoute() {
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer();
    //let start = "Santa ApolÃ³nia, Lisboa";
    // let end = "Rato, Lisboa";
    let start = document.getElementById('start').value;
    let end = document.getElementById('end').value;
    let request = {
      origin: start,
      destination: end,
      travelMode: "DRIVING"
    };
    directionsService.route(request, (result, status) => {
      if (status === "OK") {
        routeDestinationCoordinates = {
          lat: result.routes[0].legs[0].end_location.lat(),
          lng: result.routes[0].legs[0].end_location.lng(),
        }

        directionsRenderer.setDirections(result);
      }
    })
    directionsRenderer.setMap(map);
  }


  function showMarkers(markers) { // Markers will be an array of objects with {lat, lgn }
    markers.forEach((marker) => {
      setMarker(marker);
    });
  }

  function setMarker(marker, name) {
    // console.log('marker', marker);
    let customMarker = new google.maps.Marker({
      position: marker,
      map: map
    });
    const infowindow = new google.maps.InfoWindow({
      content: name,
    });
    customMarker.addListener("click", () => {
      infowindow.open(map, customMarker);
    });
    markers.push(customMarker)
  }


  function getCurrentLocation() { // Geolocation 
    navigator.geolocation.getCurrentPosition((position) => {
      const pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      }
      setMarker(pos);
      map.setCenter(pos);
      map.setZoom(13);
    });
  }

  document.getElementById('routeSearchForm').addEventListener('submit', (event) => {
    event.preventDefault();
  })

  document.getElementById('placesForm').addEventListener('submit', (event) => {
    event.preventDefault();
    searchPlaces(event);
  })

  // Sets the map on all markers in the array.
  function setMapOnAll(map) {
    for (let i = 0; i < markers.length; i++) {
      markers[i].setMap(map);
    }
  }

  function clearMarkers() {
    setMapOnAll(null);
    markers = [];
  }

  function clearRoute() {
    // Clear past routes
    directionsRenderer.setMap(null)
    document.getElementById('start').value = ''
    document.getElementById('end').value = ''
  }

</script>